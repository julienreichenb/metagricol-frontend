<template>
    <div id="sidebar-exploitation" :class="isOpen ? ' open' : ''" class="bg-dark text-white">
        <div class="pb-2 d-flex" :class="isOpen ? 'border-bottom border-light justify-content-between' : 'justify-content-around'">
            <b-link @click="$emit('switch')">
                <font-awesome-icon class="lead" :class="openText && ' ml-3'" :icon="isOpen ? ['fas', 'arrow-from-left'] : ['fas', 'arrow-from-right']" />
            </b-link>
            <span v-if="openText" class="ml-2" v-html="$t(tKey + 'title').toUpperCase()" />
            <span v-if="openText" />
        </div>
        <div v-if="openText">
            <search-bar class="my-2"
                :placeholderKey="'placeholderExploitant'"
                @search="filterExploitations"
            />
            <b-table id="exploitations-table" 
                class="text-left" 
                :items="filteredExploitations"
                :fields="fields"
                :per-page="perPage"
                :current-page="currentPage"
                :busy="!exploitations.length"       
                @row-clicked="selectExploitation"
                small
                striped
                hover
            >
                <template #table-busy>
                    <div class="text-center my-5">
                        <loading :customClass="'fa-3x'" :text="'utils.loading'" />
                    </div>
                </template>
                <template #cell(selected)="data">
                    <div class="text-center">
                        <span aria-hidden="true">
                            <font-awesome-icon :icon="isSelected(data.item.idexploitation) ? ['fas', 'check-circle'] : 'circle'" 
                                :color="isSelected(data.item.idexploitation) ? 'green' : 'lightgrey'" 
                            />
                        </span>
                    </div>
                </template>
                <template #cell(actions)="data">
                    <div class="text-right">
                        <b-button variant="outline-dark" @click="goToDetail(data.item)">
                            <font-awesome-icon :icon="['fas', 'eye']" class="mr-1" />
                            {{ $t(tKey + 'button') }}
                        </b-button>
                    </div>
                </template>
            </b-table>
            <b-row>
                <b-col sm="8">
                    <b-pagination
                        v-model="currentPage"
                        :total-rows="rows"
                        :per-page="perPage"
                        aria-controls="exploitations-table"
                        align="fill"
                    />
                </b-col>
                <b-col>
                    <b-button-group class="d-flex">
                        <b-button @click="selectAll" variant="light" :disabled="!exploitations.length">
                            <font-awesome-icon :icon="['fas', 'check-circle']" color="green" class="mr-2" />
                            <b>{{ $t('utils.all') }}</b>
                        </b-button>
                        <b-button @click="clearSelection" variant="light" :disabled="!exploitations.length">
                            <font-awesome-icon :icon="['fas', 'times-circle']" color="red" class="mr-2" />
                            <b>{{ $t('utils.none') }}</b>
                        </b-button>
                    </b-button-group>
                </b-col>
            </b-row>
        </div>
    </div>
</template>

<script>
import ExploitationMixin from '@/mixins/exploitation'
export default {
    name: 'SideExploitation',
    mixins: [ExploitationMixin],
    props: {
        isOpen: { type: Boolean, required: true },
    },
    data() {
        return {
            tKey: 'sidebar.exploitation.',
            openText: false,
            perPage: 13,
            currentPage: 1,
            filteredExploitations: [],
        }
    },
    computed: {
        fields() {
            return [
                {
                    key: 'selected',
                    label: '',
                    sortable: false,
                },
                {
                    key: 'noctexploitation',
                    label: 'No CT Exploitation',
                    sortable: false,
                },
                {
                    key: 'exploitant.fullname',
                    label: 'Exploitant',
                    sortable: true,
                },
                {
                    key: 'totalugb',
                    label: 'UGB',
                    sortable: true,
                    formatter: (val) => {
                        return val.toLocaleString('fr-ch')
                    },
                },
                {
                    key: 'totalmilk',
                    label: 'Kgs de lait',
                    sortable: true,
                    formatter: (val) => {
                        return val.toLocaleString('fr-ch')
                    },
                },
                {
                    key: 'actions',
                    label: '',
                    sortable: false,
                },
            ]
        },
        rows() {
            return this.filteredExploitations.length
        },
    },
    watch: {
        isOpen(val) {
            setTimeout(() => {
                this.openText = val
            }, val ? 320 : 0)
        },
    },
    async mounted() {
        await this.getExploitationsSummary()
        this.filteredExploitations = this.exploitations
    },
    methods: {
        filterExploitations(query) {
            if(!query || query === '') {
                this.filteredExploitations = this.exploitations
                return
            }
            this.filteredExploitations = this.exploitations.filter(e => 
                e.noctexploitation.toLowerCase().includes(query.toLowerCase()) || 
                e.exploitant.fullname.toLowerCase().includes(query.toLowerCase())
            )
            this.currentPage = 1
        },
        goToDetail(item) {
            this.$router.push(
                this.$i18nRoute({ 
                    name: 'ExploitationDetail', 
                    params: { idexploitation: item.idexploitation } 
                })
            )
        },
    }
}
</script>

<style lang="scss">
#sidebar-exploitation {
    position: fixed;
    right: 0;
    top: $navbar-height - 3;
    bottom: 0;
    z-index: $z-sidebar;
    padding: .5em 0;
    overflow-y: auto;
    overflow-x: hidden;    
    height: 100%;
    width: $sidebar-width-closed;
    transition: $default-transition;
    box-shadow: -5px 0 15px 1px white;

    a {
        text-decoration: none;
        color: white;
    }

    &.open {
        width: 65vw;
        padding: .5em .5em;
    }
}
#exploitations-table {
    background-color: white;
}
</style>